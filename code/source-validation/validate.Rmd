---
title: 'gpt source extraction validation'
---

# 0: Loading the data
```{r}
library(tidyverse)
library(Hmisc)
library(here)
hy_corrections <- read_csv(here("code/annotation/annotator_errors_hy.csv"))
df2 <- read_tsv(here("code/annotation/annotation_output.250.v2.tsv")) %>%
    unique() %>%
    filter(
        !is.na(cite.anno) | source_type == "new"
    ) %>%
    mutate(
        cite.anno = ifelse(cite.anno == "Yes-Dup", "Yes", cite.anno),
        detail.correction = case_when(
            tolower(person_name.anno) != tolower(person_name.gpt) ~ "person_name",
            tolower(person_title.anno) != tolower(person_title.gpt) ~ "person_title",
            tolower(organization.anno) != tolower(organization.gpt) ~ "organization",
            tolower(category.anno) != tolower(category.gpt) ~ "category",
            TRUE ~ NA
        ),
        error = case_when(
            source_type == "new" ~ "This source did not get extracted by GPT (Type II)",
            cite.anno != "Yes" ~ "This source isn't cited in the text (Type I)",
            !is.na(detail.correction) ~ paste("Error in", detail.correction),
            TRUE ~ NA
        )
    ) %>% left_join(hy_corrections) %>% mutate(
        hy_coding = `HY_coding_was_annotator_correct?`,
        detail_error = str_detect(error, 'Error in') & hy_coding == "1",
        false_source = str_detect(error, fixed('Type I)')) & hy_coding == "1",
        missing_source = str_detect(error, fixed('Type II)')) & hy_coding == "1",
    )
df2.q <- df2 %>% filter(coder_qual)

det <- sum(df2.q$detail_error, na.rm=T)
fps <- sum(df2.q$false_source, na.rm=T)
fns <- sum(df2.q$missing_source, na.rm=T)

detq <- sum(df2$detail_error, na.rm=T)
fpsq <- sum(df2$false_source, na.rm=T)
fnsq <- sum(df2$missing_source, na.rm=T)
binconf(fnsq, nrow(df2), alpha = 0.05, method = "all")[1, ]
binconf(fpsq, nrow(df2), alpha = 0.05, method = "all")[1, ]
binconf(detq, nrow(df2), alpha = 0.05, method = "all")[1, ]

est.fp <- binconf(fns, nrow(df2.q), alpha = 0.05, method = "all")[1, ]
est.fn <- binconf(fps, nrow(df2.q), alpha = 0.05, method = "all")[1, ]
est.det <- binconf(det, nrow(df2.q), alpha = 0.05, method = "all")[1, ]
err.df <- rbind(est.fp, est.fn, est.det) %>%
    as.data.frame() %>%
    mutate(name = c("Type I", "Type II", "Name/Title/Organization"))
err.df %>%
    ggplot(aes(x = name, y = PointEst, ymin = Lower, ymax = Upper)) +
    geom_point() +
    geom_errorbar(width = 0) +
    theme_bw() +
    labs(
        title = "Error rates of GPT source extraction",
        # subtitle = "95% Confidence Intervals constructed with Bernoulli random variable model",
        y = "Value",
        x = "",
    ) +
    theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
    ) + scale_y_continuous(limits=c(0,NA), labels = scales::percent)
ggsave(here("paper/figures/validation-result.png"), width = 4.5, height = 4.5)
```
